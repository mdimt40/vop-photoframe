<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡¶¶‡ßÅ‡¶Æ‡¶ï‡ßÄ‡¶§‡ßá ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶® ‡¶ö‡¶æ‡¶á</title>
    <!-- Fonts for Bangla -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Cropper.js for image manipulation -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <!-- Consolidated Styles from style.css -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Hind Siliguri', sans-serif;
        }
        
        body {
            background: #fff5f5;
            color: #333;
            line-height: 1.6;
        }
        
        /* White Header with Logo */
        .logo-header {
            background: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logo-container {
            padding: 10px;
            display: inline-block;
        }
        
        .logo {
            width: 250px;
            height: auto;
            object-fit: contain;
        }
        
        /* Red Content Section */
        .red-content {
            background: #d62828;
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .red-content h1 {
            font-size: 28px;
            margin: 10px 0;
            color: white;
        }
        
        .red-content .bio {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            margin: 15px auto;
            max-width: 800px;
            font-size: 16px;
        }
        
        .red-content h2 {
            color: white;
            margin: 20px 0 10px;
            font-size: 22px;
        }
        
        .red-content h2::after {
            background: white;
        }
        
        .red-content ul li {
            color: white;
        }
        
        .red-content ul li:before {
            color: #ffffff;
        }
        ul {
            text-align: center; /* Center the text */
            max-width: 700px;
            margin: 15px auto;
            padding-left: 0; /* Remove default padding */
            list-style-type: none;
            display: inline-block; /* Make the ul only as wide as its content */
        }
        
        ul li {
            position: relative;
            padding: 8px 0;
            color: #444;
            text-align: left; /* Align text to left within centered container */
            padding-left: 25px; /* Space for custom bullet */
        }
        
        ul li:before {
            content: "‚Ä¢";
            color: #d62828;
            font-size: 20px;
            position: absolute;
            left: 5px; /* Position bullet closer to text */
        }
        .hashtags {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .hashtag {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            color: white;
        }
        
        /* Rest of the styles */
        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 30px;
            background: #fff;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            border: 1px solid #ffe0e0;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #d62828, #b22222);
        }
        
        .upload-label {
            background: linear-gradient(135deg, #d62828, #b22222);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(214, 40, 40, 0.3);
        }
        
        #statusMessage {
            color: #d62828; /* Use the primary red for status messages */
            font-weight: 600;
            margin-top: 15px;
        }

        canvas {
            margin: 20px auto;
            max-width: 100%;
            border: 2px dashed #d62828;
            border-radius: 12px;
            background-color: #f9f9f9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        button {
            margin-top: 25px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            background: linear-gradient(135deg, #d62828, #b22222);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .support-text {
            text-align: center;
            margin: 20px 0;
            font-style: italic;
            color: #666;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            background: linear-gradient(135deg, #d62828, #b22222);
            color: white;
        }
        
        .social-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .logo {
                width: 180px;
            }
            
            .red-content h1 {
                font-size: 22px;
            }
            
            .container {
                padding: 20px;
                margin: 20px;
            }
        }
        
        /* Cropper Modal Styles */
        #cropModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000cc;
            display: none; /* Controlled by JS */
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        #cropModal .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
        }
        #cropBtn {
            background-color: #049f50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }
        #cropBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- White Header with Logo Only -->
    <header class="logo-header">
        <div class="logo-container">
            <!-- logo.png reference restored. NOTE: This image file must be accessible to run locally. -->
            <img src="logo.png" alt="Logo" class="logo" />
        </div>
    </header>

    <!-- Red Content Section -->
    <section class="red-content">
        <h1>‡¶¶‡ßÅ‡¶Æ‡¶ï‡ßÄ‡¶§‡ßá ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶® ‡¶ö‡¶æ‡¶á, ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶æ‡¶∞</h1>
        <p class="bio">‡¶™‡¶ü‡ßÅ‡¶Ø‡¶º‡¶æ‡¶ñ‡¶æ‡¶≤‡ßÄ ‡¶ú‡ßá‡¶≤‡¶æ‡¶∞ ‡¶∏‡¶¨‡¶•‡ßá‡¶ï‡ßá ‡¶õ‡ßã‡¶ü ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶¶‡ßÅ‡¶Æ‡¶ï‡ßÄ ‡¶π‡¶≤‡ßá‡¶ì ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡ßÆ‡ß™,‡ß´‡ß¨‡ß´ ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑ ‡¶è‡¶∞ ‡¶¨‡¶∏‡¶¨‡¶æ‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶ü‡ßÅ‡¶Ø‡¶º‡¶æ‡¶ñ‡¶æ‡¶≤‡ßÄ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶ì ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡¶Ø‡¶º‡•§ 
        ‡¶∏‡¶æ‡¶•‡ßá‡¶á ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶¨‡¶∞‡¶ø‡¶∂‡¶æ‡¶≤ ‡¶∏‡ßá‡¶®‡¶æ‡¶®‡¶ø‡¶¨‡¶æ‡¶∏ (‡¶™‡¶ü‡ßÅ‡¶Ø‡¶º‡¶æ‡¶ñ‡¶æ‡¶≤‡ßÄ ‡¶∏‡ßá‡¶®‡¶æ‡¶®‡¶ø‡¶¨‡¶æ‡¶∏) ‡¶∏‡¶ï‡¶≤ ‡¶¶‡¶ø‡¶ï ‡¶¨‡¶ø‡¶¨‡ßá‡¶ö‡¶®‡¶æ‡¶Ø‡¶º ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡ßá ‡¶è‡¶ñ‡¶® ‡¶¶‡ßÅ‡¶Æ‡¶ï‡¶ø ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶Ø‡¶º‡ßá ‡¶¶‡¶æ‡¶Å‡¶°‡¶º‡¶ø‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§</p>
        
        <h2><i class="fas fa-question-circle"></i> ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?</h2>
        <ul>
            <li>**‡¶Ü‡¶™‡¶≤‡ßã‡¶° (Upload)** ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</li>
            <li>‡¶ï‡ßç‡¶∞‡¶™‡¶ø‡¶Ç ‡¶ü‡ßÅ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø **‡ß™:‡ß´ ‡¶Ö‡¶®‡ßÅ‡¶™‡¶æ‡¶§‡ßá** ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</li>
            <li>**Crop & Apply** ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá AI ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡ßá ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶¨‡ßá‡•§</li>
            <li>‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶≤‡¶æ‡¶ó‡¶≤‡ßá **‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°** ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï‡ßá ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</li>
        </ul>
        
        <p class="bio">‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá Voice of Patuakhali ‡¶™‡ßá‡¶ú ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶∂‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶≠‡ßÅ‡¶≤‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§ 
            ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶π‡ßç‡¶Ø‡¶æ‡¶∏‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶® ‚Üì</p>
        
        <div class="hashtags">
            <span class="hashtag">#‡¶¶‡ßÅ‡¶Æ‡¶ï‡ßÄ‡¶§‡ßá_‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞_‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®_‡¶ö‡¶æ‡¶á</span>
            <span class="hashtag">#Dumki_fire_station</span>
            <span class="hashtag">#voice_of_patuakhali</span>
        </div>
    </section>

    <main class="container">
        <label class="upload-label">
            <i class="fas fa-upload"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
            <input type="file" id="imageUpload" accept="image/png, image/jpeg" hidden />
        </label>
        
        <p id="statusMessage">‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶õ‡¶ø...</p>

        <canvas id="canvas" width="1000" height="1000"></canvas>

        <div id="cropModal">
            <div class="modal-content">
                <img id="cropImage" />
                <br><br>
                <button id="cropBtn" disabled>Crop & Apply</button>
            </div>
        </div>
        
        <button id="downloadBtn" disabled>
            <i class="fas fa-download"></i> ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </main>

    <p class="support-text">
        ‡¶™‡ßç‡¶∞‡¶ö‡¶æ‡¶∞‡ßá : ‡¶¶‡ßÅ‡¶Æ‡¶ï‡ßÄ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ‡¶¨‡¶æ‡¶∏‡ßÄ<br>
        ‡¶∏‡¶π‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ‡¶Ø‡¶º : ‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶Ö‡¶´ ‡¶™‡¶ü‡ßÅ‡¶Ø‡¶º‡¶æ‡¶ñ‡¶æ‡¶≤‡ßÄ
    </p>

    <footer>
        <p>&copy; 2025 Voice of Patuakhali</p>
    </footer>

    <!-- Consolidated JavaScript Logic from script3.js + API integration -->
    <script>
        // --- API CONFIGURATION ---
        const BEARER_TOKEN = "10596|Ayal26XqnUC6ZV2Mre3pj0HyrLiDL8hM1t9BHVKQ";
        const API_ENDPOINT = "https://zylalabs.com/api/4405/human+background+removal+api/5414/human+background+removal"; 
        // -------------------------

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const imageUpload = document.getElementById('imageUpload');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusMessage = document.getElementById('statusMessage');
        const cropModal = document.getElementById('cropModal');
        const cropImage = document.getElementById('cropImage');
        const cropBtn = document.getElementById('cropBtn');

        let cropper = null;
        let finalCutoutUrl = null;

        // Poster template image (Reference restored to your file: poster-template.png)
        const poster = new Image();
        poster.crossOrigin = 'Anonymous'; // Needed if template is hosted
        poster.src = 'poster-template.png'; 

        let uploadedImage = null; // This will hold the transparent image object after API call
        
        // --- RESTORED ORIGINAL POSITIONS ---
        let imageX = 30; 
        let imageY = 640; 
        const photoWidth = 520;
        const photoHeight = 520;
        // -----------------------------------

        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        // --- Utility Functions ---

        /**
         * Converts a data URL (Base64) to a Blob object.
         */
        function dataURLtoFile(dataurl, filename) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, { type: mime });
        }


        // --- Canvas and Drawing Logic (Restored from script3.js) ---

        poster.onload = () => {
            canvas.width = 1000;
            canvas.height = 1000;
            // Draw initial template (will draw only the poster if uploadedImage is null)
            drawPoster();
        };
        
        poster.onerror = () => {
             statusMessage.textContent = "‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: 'poster-template.png' ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
        }


        function drawPoster() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // 1. Draw the Base Template Image (poster-template.png)
            ctx.drawImage(poster, 0, 0, canvas.width, canvas.height);
            
            // 2. Draw the AI-Processed Transparent Subject Image (Restored original drawing logic)
            if (uploadedImage) {
                // Draw white border first
                const borderPadding = 2; // Original logic had 2px padding on strokeRect, leading to 4px total border
                ctx.lineWidth = borderPadding * 2; 
                ctx.strokeStyle = "white";
                
                // Shadow for depth (Retained the shadow effect for better visuals)
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 3;
                ctx.shadowOffsetY = 3;

                ctx.strokeRect(
                    imageX - borderPadding,
                    imageY - borderPadding,
                    photoWidth + borderPadding * 2,
                    photoHeight + borderPadding * 2
                );

                // Clear shadow for image drawing
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                
                // Then draw the uploaded photo (transparent cutout)
                ctx.drawImage(uploadedImage, imageX, imageY, photoWidth, photoHeight);
            }
        }


        // --- Cropping, Upload, and API Flow (Integrated) ---

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                statusMessage.textContent = "‡¶õ‡¶¨‡¶ø ‡¶ï‡ßç‡¶∞‡¶™ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶õ‡ßá...";
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Show Cropping Modal
                    cropModal.style.display = 'flex';
                    cropImage.src = event.target.result;
                    cropBtn.disabled = false;
                    
                    if (cropper) {
                        cropper.destroy();
                    }
                    
                    // Initialize Cropper.js (4:5 ratio requested by user for the canvas)
                    cropper = new Cropper(cropImage, {
                        aspectRatio: 4 / 5, 
                        viewMode: 1, 
                        background: false,
                        ready() {
                            cropBtn.disabled = false;
                        }
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        cropBtn.addEventListener('click', async () => {
            if (cropper) {
                cropBtn.disabled = true;
                statusMessage.textContent = "‡¶õ‡¶¨‡¶ø ‡¶ï‡ßç‡¶∞‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

                // 1. Get cropped file
                const croppedDataUrl = cropper.getCroppedCanvas({
                    width: photoWidth, // Use canvas photo size for best fit
                    height: photoHeight,
                }).toDataURL('image/png');

                // 2. Convert Data URL to a File object for API upload
                const croppedFile = dataURLtoFile(croppedDataUrl, 'cropped_subject.png');

                // 3. Hide the modal
                cropModal.style.display = 'none';
                cropper.destroy();
                cropper = null;

                // 4. Call the API (This is the new function)
                await sendForBackgroundRemoval(croppedFile);
            }
        });


        async function sendForBackgroundRemoval(file) {
            statusMessage.textContent = "AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡¶∏‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá... (‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶∏‡¶Æ‡ßü ‡¶≤‡¶æ‡¶ó‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá)";
            downloadBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('return_form', 'optional'); 

                let response = null;
                const maxRetries = 3;

                // Exponential Backoff
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${BEARER_TOKEN}`,
                            },
                            body: formData
                        });

                        if (response.ok) {
                            break;
                        } else if (response.status === 429) {
                            console.warn(`Rate limit (429) hit. Retrying in ${Math.pow(2, i)} seconds...`);
                            if (i < maxRetries - 1) {
                                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                            } else {
                                throw new Error("API Rate limit exceeded after multiple retries.");
                            }
                        } else {
                            throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                        }
                    } catch (error) {
                        if (i === maxRetries - 1) throw error;
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }

                if (!response || !response.ok) {
                    throw new Error("API ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶´‡¶≤ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
                }

                const result = await response.json();
                
                const processedImageUrl = result.data?.image_url;
                
                if (processedImageUrl) {
                    finalCutoutUrl = processedImageUrl;
                    
                    // Load the transparent image into the global uploadedImage variable (RESTORING ORIGINAL FLOW)
                    uploadedImage = new Image();
                    uploadedImage.crossOrigin = 'Anonymous';
                    uploadedImage.onload = () => {
                        // Restore default positioning for the new image
                        imageX = 30; 
                        imageY = 640; 
                        drawPoster(); // Redraw poster with the new transparent image
                        downloadBtn.disabled = false;
                        statusMessage.textContent = "‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®! ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡•§";
                    };
                    uploadedImage.onerror = () => {
                        statusMessage.textContent = "‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶π‡¶ì‡ßü‡¶æ ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
                    };
                    uploadedImage.src = processedImageUrl; 
                    
                    statusMessage.textContent = "‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡¶™‡¶∏‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
                    
                } else {
                    const errorMsg = result.error_detail?.message || JSON.stringify(result, null, 2);
                    statusMessage.textContent = `‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡¶∏‡¶æ‡¶∞‡¶£ ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá‡¶ì ‡¶õ‡¶¨‡¶ø‡¶∞ URL ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§`;
                    console.error("API Result Missing URL:", errorMsg);
                }

            } catch (error) {
                statusMessage.textContent = `‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡¶§‡¶æ‡•§ ‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§`;
                console.error("Background removal error:", error);
            } finally {
                cropBtn.disabled = false;
            }
        }


        // --- Dragging Logic (Restored from script3.js) ---

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (uploadedImage && 
                x >= imageX && x <= imageX + photoWidth &&
                y >= imageY && y <= imageY + photoHeight
            ) {
                isDragging = true;
                dragOffsetX = x - imageX;
                dragOffsetY = y - imageY;
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const rect = canvas.getBoundingClientRect();
                imageX = e.clientX - rect.left - dragOffsetX;
                imageY = e.clientY - rect.top - dragOffsetY;

                drawPoster();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
        });

        // üéØ Touch events for mobile drag support
        canvas.addEventListener('touchstart', (e) => {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            if (uploadedImage && 
                x >= imageX && x <= imageX + photoWidth &&
                y >= imageY && y <= imageY + photoHeight
            ) {
                isDragging = true;
                dragOffsetX = x - imageX;
                dragOffsetY = y - imageY;
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            if (isDragging) {
                e.preventDefault(); // Prevent scrolling while dragging
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];

                imageX = touch.clientX - rect.left - dragOffsetX;
                imageY = touch.clientY - rect.top - dragOffsetY;

                drawPoster();
            }
        }, { passive: false });

        canvas.addEventListener('touchend', () => {
            isDragging = false;
        });

        canvas.addEventListener('touchcancel', () => {
            isDragging = false;
        });


        // --- Download Logic (Restored from script3.js) ---

        downloadBtn.addEventListener('click', () => {
            if (!finalCutoutUrl) {
                statusMessage.textContent = "‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶ó‡ßá ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                return;
            }
            downloadBtn.disabled = true;
            statusMessage.textContent = "‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            
            const link = document.createElement('a');
            link.download = `‡¶¶‡ßÅ‡¶Æ‡¶ï‡ßÄ‡¶§‡ßá_‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞_‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏_‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®_‡¶ö‡¶æ‡¶á_‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶æ‡¶∞.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

            downloadBtn.disabled = false;
            statusMessage.textContent = "‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®‡•§";
        });
        
    </script>
</body>
</html>
